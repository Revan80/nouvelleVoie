<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administration - La Nouvelle Voie</title>
  <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: #f8fafc;
    }
    
    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    
    .auth-form {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      max-width: 400px;
      width: 100%;
    }
    
    .auth-form h2 {
      color: #1e3a8a;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #374151;
    }
    
    .form-group input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #1e3a8a;
    }
    
    .btn {
      width: 100%;
      padding: 0.75rem;
      background: #1e3a8a;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin-bottom: 1rem;
    }
    
    .btn:hover {
      background: #1e40af;
    }
    
    .toggle-link {
      text-align: center;
      color: #1e3a8a;
      cursor: pointer;
      text-decoration: underline;
    }
    
    .hidden {
      display: none;
    }
    
    .message {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      text-align: center;
    }
    
    .success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
    
    .error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
  </style>
</head>
<body>
  <!-- Interface d'authentification -->
  <div id="auth-container" class="auth-container">
    <div class="auth-form">
      <!-- Formulaire de connexion -->
      <div id="login-form">
        <h2>Administration - La Nouvelle Voie</h2>
        <div id="message"></div>
        <p style="color: #64748b; margin-bottom: 1.5rem; text-align: center;">
          Cliquez sur le bouton pour vous connecter avec vos identifiants Netlify Identity
        </p>
        <button class="btn" onclick="handleLogin()">Se connecter</button>
        <div class="toggle-link" onclick="showSignup()">Pas encore de compte ? S'inscrire</div>
      </div>

      <!-- Formulaire d'inscription -->
      <div id="signup-form" class="hidden">
        <h2>Inscription Administration</h2>
        <div id="signup-message"></div>
        <div class="form-group">
          <label for="signup-email">Email</label>
          <input type="email" id="signup-email" required>
        </div>
        <div class="form-group">
          <label for="signup-password">Mot de passe</label>
          <input type="password" id="signup-password" required>
        </div>
        <div class="form-group">
          <label for="signup-name">Nom complet</label>
          <input type="text" id="signup-name" required>
        </div>
        <button class="btn" onclick="handleSignup()">S'inscrire</button>
        <div class="toggle-link" onclick="showLogin()">Déjà un compte ? Se connecter</div>
      </div>
    </div>
  </div>

  <!-- Container pour Netlify CMS (caché initialement) -->
  <div id="cms-container" class="hidden"></div>

  <script>
    // Initialisation de Netlify Identity
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (user) {
          // Utilisateur déjà connecté, charger le CMS
          loadCMS();
        }
      });

      window.netlifyIdentity.on("login", user => {
        // Connexion réussie, charger le CMS
        loadCMS();
      });

      window.netlifyIdentity.on("logout", () => {
        // Déconnexion, retourner à l'écran de connexion
        showAuthForm();
      });
    }

    function showMessage(elementId, message, type) {
      const messageEl = document.getElementById(elementId);
      messageEl.innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(() => {
        messageEl.innerHTML = '';
      }, 5000);
    }

    function showLogin() {
      document.getElementById('login-form').classList.remove('hidden');
      document.getElementById('signup-form').classList.add('hidden');
    }

    function showSignup() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('signup-form').classList.remove('hidden');
    }

    function showAuthForm() {
      document.getElementById('auth-container').classList.remove('hidden');
      document.getElementById('cms-container').classList.add('hidden');
    }

    function loadCMS() {
      document.getElementById('auth-container').classList.add('hidden');
      document.getElementById('cms-container').classList.remove('hidden');
      
      // Charger Netlify CMS
      if (!document.querySelector('script[src*="netlify-cms"]')) {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js';
        document.getElementById('cms-container').appendChild(script);
      }
    }

    function handleLogin() {
      if (window.netlifyIdentity) {
        showMessage('message', 'Ouverture de la fenêtre de connexion...', 'success');
        
        // Ouvrir la popup de connexion Netlify Identity
        window.netlifyIdentity.open('login');
        
        // Écouter les événements de connexion
        window.netlifyIdentity.on('login', user => {
          showMessage('message', '✅ Connexion réussie !', 'success');
          setTimeout(() => {
            loadCMS();
          }, 1000);
        });
        
        window.netlifyIdentity.on('error', err => {
          console.error('Erreur de connexion:', err);
          showMessage('message', '❌ Erreur de connexion. Vérifiez vos identifiants.', 'error');
        });
        
      } else {
        showMessage('message', 'Service d\'authentification non disponible', 'error');
      }
    }

    function handleSignup() {
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const name = document.getElementById('signup-name').value;

      if (!email || !password || !name) {
        showMessage('signup-message', 'Veuillez remplir tous les champs', 'error');
        return;
      }

      if (window.netlifyIdentity) {
        window.netlifyIdentity.open('signup');
      } else {
        showMessage('signup-message', 'Service d\'authentification non disponible', 'error');
      }
    }

    // Vérifier l'état initial
    window.addEventListener('load', function() {
      if (window.netlifyIdentity) {
        // Gérer les tokens de confirmation dans l'URL
        const hash = window.location.hash;
        if (hash.includes('confirmation_token') || hash.includes('email_change_token') || hash.includes('recovery_token')) {
          showMessage('message', 'Confirmation en cours...', 'success');
          
          // Attendre que Netlify Identity traite le token
          setTimeout(() => {
            const user = window.netlifyIdentity.currentUser();
            if (user) {
              showMessage('message', '✅ Compte confirmé avec succès !', 'success');
              setTimeout(() => {
                loadCMS();
              }, 2000);
            } else {
              showMessage('message', 'Confirmation terminée. Vous pouvez maintenant vous connecter.', 'success');
              // Nettoyer l'URL
              window.history.replaceState({}, document.title, window.location.pathname);
            }
          }, 3000);
        } else {
          const user = window.netlifyIdentity.currentUser();
          if (user) {
            loadCMS();
          }
        }
      }
    });
  </script>
</body>
</html>
